# A realistic aspect description from a determinate-OCD context-engineering
# pipeline. This TOML would be generated by `nix eval` extracting the
# .description field from a den aspect, then processed by nuenv.

[aspect]
id      = "ocd.gateway"
version = "0.2.0"
role    = "Configure Caddy reverse proxy for OpenClaw TLS termination"

[context]
id = "gateway-ctx"

[[context.entries]]
key   = "proxy-target"
value = "127.0.0.1:18789 (OpenClaw gateway, loopback-only)"

[[context.entries]]
key   = "tls-provider"
value = "Let's Encrypt via Caddy automatic HTTPS"

[[context.entries]]
key   = "webhook-port"
value = "8787 (loopback-only, proxied for Telegram webhooks)"

[[constraints]]
text     = "TLS certificates must be valid and auto-renewed"
severity = "security"

[[constraints]]
text     = "Proxy timeout must not exceed 30 seconds"
severity = "performance"

[[constraints]]
text     = "Gateway port 18789 must never be exposed externally"
severity = "security"

[rationale]
design     = "External access routes through Caddy reverse proxy to avoid exposing OpenClaw directly"
motivation = "Defense in depth: TLS termination + loopback isolation + capability dropping"

[[steps]]
text = "Enable Caddy service with systemd"

[[steps]]
text = "Configure reverse proxy rules for gateway and webhook endpoints"

[[steps]]
text = "Verify TLS certificate issuance for the configured domain"

[[inputs]]
name        = "domain"
type        = "string"
description = "Public domain for TLS certificate (e.g. gateway.example.com)"

[[inputs]]
name        = "webhook-path"
type        = "string"
description = "URL path for Telegram webhook endpoint"

[schema]
id = "gateway-output"

[[schema.fields]]
name        = "tls-active"
type        = "bool"
description = "Whether TLS is active and certificate is valid"

[[schema.fields]]
name        = "proxy-status"
type        = "enum(healthy|degraded|down)"
description = "Current reverse proxy health status"

[[checkpoints]]
id         = "verify-tls"
after-step = 3
assertion  = "TLS certificate is valid and not expiring within 7 days"
on-fail    = "halt"

[[checkpoints]]
id         = "verify-loopback"
after-step = 2
assertion  = "Gateway port 18789 is not in allowedTCPPorts"
on-fail    = "halt"
